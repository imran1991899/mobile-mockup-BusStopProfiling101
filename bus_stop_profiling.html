<script>
// ---------------- AUTO TIMESTAMP ----------------
function updateTimestamp() {
  const now = new Date();
  const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
    .toISOString().slice(0,16);
  document.getElementById("timestamp").value = local;
}
window.onload = updateTimestamp;

// ---------------- LOAD BUS STOP DATA FROM CSV ----------------
const busStopIndex = {};
const busStopSelect = document.getElementById("busStop");

// üî¥ CHANGE THIS TO YOUR CSV RAW URL ON GITHUB
const csvUrl = "https://github.com/imran1991899/mobile-mockup-BusStopProfiling101/blob/main/busstop_data.csv";

fetch(csvUrl)
  .then(res => res.text())
  .then(text => parseCSV(text))
  .catch(err => alert("‚ùå Cannot load bus stop data from GitHub"));

function parseCSV(text) {
  const rows = text.trim().split("\n");
  const headers = rows.shift().split(",").map(h => h.trim());

  rows.forEach(row => {
    const cols = row.split(",").map(c => c.trim());
    const data = {};
    headers.forEach((h, i) => data[h] = cols[i]);

    // Build busStopIndex
    if (!busStopIndex[data.BusStop]) {
      busStopIndex[data.BusStop] = {
        routes: [],
        depot: data.Depot,
        direction: data.Direction
      };
    }

    if (!busStopIndex[data.BusStop].routes.includes(data.Route)) {
      busStopIndex[data.BusStop].routes.push(data.Route);
    }
  });

  populateBusStops();
}

function populateBusStops() {
  Object.keys(busStopIndex).sort().forEach(stop => {
    busStopSelect.innerHTML += `<option value="${stop}">${stop}</option>`;
  });
}

// ---------------- TYPE-TO-SEARCH INSIDE BUS STOP SELECT ----------------
let typeBuffer = "";
let bufferTimeout = null;

busStopSelect.addEventListener("keydown", function (e) {
  if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
    typeBuffer += e.key.toLowerCase();
    clearTimeout(bufferTimeout);
    bufferTimeout = setTimeout(() => typeBuffer = "", 700);

    for (let i = 0; i < this.options.length; i++) {
      if (this.options[i].text.toLowerCase().startsWith(typeBuffer)) {
        this.selectedIndex = i;
        this.dispatchEvent(new Event("change")); // auto-fill route/depot
        break;
      }
    }
  }
});

// ---------------- AUTO FILL ----------------
busStopSelect.addEventListener("change", function () {
  const d = busStopIndex[this.value];
  if (!d) return;
  document.getElementById("route").value = d.routes.join(" / ");
  document.getElementById("depot").value = d.depot;
  document.getElementById("direction").value = d.direction;
});

// ---------------- ISSUE MAPPING (ORIGINAL) ----------------
const mapping = {
  "Construction in progress nearby the bus stop": { sub: "A2 - Pax", cat: "A - Safety" },
  "Missing infrastructure": { sub: "B1 - Missing Pole", cat: "B - Insufficient Infra" },
  "Covered by trees": { sub: "C1 - Routine", cat: "C - Maintenance" },
  "Malfunction lights": { sub: "C2 - Infra", cat: "C - Maintenance" },
  "Outdated info panel": { sub: "C2 - Infra", cat: "C - Maintenance" },
  "No bus marking - shelter": { sub: "C3 - Bus Bay (Shelter)", cat: "C - Maintenance" },
  "No bus marking - pole": { sub: "C4 - Bus Bay (Pole)", cat: "C - Maintenance" },
  "No street lighting": { sub: "C5 - Street Lighting", cat: "C - Maintenance" },
  "Parking issue": { sub: "D1 - Enforcement", cat: "D - Enforcement" }
};

document.getElementById("issue").addEventListener("change", function () {
  const m = mapping[this.value];
  document.getElementById("subcat1").innerHTML = `<option>${m.sub}</option>`;
  document.getElementById("subcat2").innerHTML = `<option>${m.cat}</option>`;
});

// ---------------- PHOTO UPLOAD ----------------
const maxPhotos = 3;
let photos = [null, null, null];
const photoContainer = document.getElementById("photoContainer");

for (let i = 0; i < maxPhotos; i++) {

  const slot = document.createElement("div");
  slot.className = "photo-slot";

  slot.innerHTML = `
    <div class="upload-title" id="title${i}">Upload Picture ${i+1}</div>
    <div class="controls">
      <button type="button" class="btn-camera" id="cam${i}">üì∑ Take Photo</button>
      <button type="button" class="btn-upload" id="upload${i}">üìÅ Upload</button>
    </div>
    <input type="file" id="file${i}" accept="image/*" class="hidden">
    <video id="video${i}" class="hidden" autoplay playsinline></video>
    <canvas id="canvas${i}" class="hidden"></canvas>
  `;

  photoContainer.appendChild(slot);

  const fileInput = document.getElementById(`file${i}`);
  const uploadBtn = document.getElementById(`upload${i}`);
  const camBtn = document.getElementById(`cam${i}`);
  const video = document.getElementById(`video${i}`);
  const canvas = document.getElementById(`canvas${i}`);
  const title = document.getElementById(`title${i}`);

  uploadBtn.onclick = () => fileInput.click();

  fileInput.onchange = () => {
    photos[i] = fileInput.files[0];
    title.textContent = "üì∑ Picture Selected";
    title.style.color = "#0b2a78";
  };

  camBtn.onclick = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.classList.remove("hidden");
      video.srcObject = stream;

      camBtn.textContent = "üì∏ Capture Now";

      camBtn.onclick = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0);

        canvas.toBlob((blob) => {
          photos[i] = new File([blob], `photo${i+1}.png`, { type: "image/png" });
          title.textContent = "üì∑ Photo Captured";
          title.style.color = "#0b2a78";
        });

        video.srcObject.getTracks().forEach(t => t.stop());
        video.classList.add("hidden");
        camBtn.textContent = "üì∑ Take Photo";
      };

    } catch (err) {
      alert("Camera blocked or not available.");
    }
  };
}

// ---------------- FORM SUBMISSION ----------------
document.getElementById("profilingForm").addEventListener("submit", function (e) {
  e.preventDefault();

  if (photos.filter(p => p !== null).length < 1) {
    alert("‚ö†Ô∏è Please upload at least 1 picture.");
    return;
  }

  alert("‚úÖ Form submitted successfully!");
});
</script>


